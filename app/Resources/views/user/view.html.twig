{% extends 'base.html.twig' %}

{% block body %}

    <div class="page-header page-header-bordered">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item">User</li>
        </ol>
        <h1 class="page-title">{{ user.name }} {{ user.surname }}</h1>
    </div>

    {# renders all fields *and* the form start and end tags #}
    {#{ form(formJourney) }#}

    <div class="row">
        <div class="col-sm-12">
            <div class="panel">
                <div class="panel-heading">
                    <h3 class="panel-title">Events</h3>
                </div>
                <div class="panel-body">
                    <table id="table"
                           data-toggle="table"
                           data-search="true"
                           data-pagination="true"
                           data-classes="table table-no-bordered"
                           data-show-columns="true">
                        <thead>
                        <tr>
                            <th data-field="contactMethod">Contact Method</th>
                            <th data-field="contactReason">Contact Reason</th>
                            <th data-field="date">Date</th>
                            <th data-field="agent">Agent</th>
                            <th data-field="agentCountry">Agent Country</th>
                            <th data-field="formOrigin">Form Origin</th>
                            <th data-field="demOrigin">Dem Origin</th>
                            <th data-field="message">Message</th>
                            <th data-field="notes">Notes</th>
                            <th data-field="op">Edit</th>
                        </tr>
                        </thead>
                    </table>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-primary waves-effect waves-light add-event" data-target="#addEvent" data-toggle="modal" type="button">Add event</button>
                </div>
            </div>

            <!-- Modal Add Event-->
            <div class="modal fade" id="addEvent" aria-hidden="true" role="dialog">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                            <h4 class="modal-title" id="exampleModalTitle">Add Event</h4>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                {% include 'user/formUserEvent.html.twig' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Modal -->

            <!-- Modal Update Event-->
            <div class="modal fade" id="editEvent" aria-hidden="true" role="dialog">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                            <h4 class="modal-title" id="exampleModalTitle">Update Event</h4>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div id="ajaxresponse_formUserEventEdit"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Modal -->

            <script>
                $( document ).ready(function() {
                    var $table = $("#table");
                    var data = [
                        {% for event in userEvents %}
                        {
                            "contactMethod": '{{ event.contactMethod }}',
                            "contactReason": '{{ event.contactReason }}',
                            "date": '{{ event.date|date('d/m/Y') }}',
                            "agent": '{{ event.agentUser.name | default("") }} {{ event.agentUser.surname | default("") }}',
                            "agentCountry": '{{ event.agentUser.countryName | default("") }}',
                            "formOrigin": '{{ event.formOrigin.formName | default("") }} - {{ event.formOrigin.formDomain | default("") }} - {{ event.formOrigin.notes | default("") }}',
                            "demOrigin": '{{ event.demOrigin.demName | default("") }} - {{ event.demOrigin.discount | default("") }}% - {{ event.demOrigin.notes | default("") }}',
                            "message": '{{ event.message }}',
                            "notes": '{{ event.notes }}',
                            "op": '<button type="button" data-id="{{ event.id }}" class="btn btn-sm btn-icon btn-primary btn-round waves-effect waves-effect edit-event" data-target="#editEvent" data-toggle="modal" data-original-title="Edit"><i class="icon md-edit" aria-hidden="true"></i></button>'
                        },
                        {% endfor %}
                    ];
                    $table.bootstrapTable({data: data});

                    $table.bootstrapTable();
                    $table.bootstrapTable('hideColumn', 'agent');
                    $table.bootstrapTable('hideColumn', 'agentCountry');

                    $('.edit-event').click(function() {
                        var id = $(this).data('id');
                        var route = '{{ path('ajax_formUserEventEdit', { 'id': "PLACEHOLDER" }) }}';
                        route = route.replace("PLACEHOLDER", id);
                        $.ajax({
                            type: 'POST',
                            url:  route,
                            success: function(response) {
                                $('#ajaxresponse_formUserEventEdit').html(response);
                                $('.modal-body').find('[data-plugin="select2"]').select2({ width: '100%' });
                            },
                            async: false
                        })
                    });
                });
            </script>
        </div>
    </div>

    <div class="row">

        <div class="col-sm-12 col-md-6">

            <div class="panel">
                <div class="panel-heading">
                    <h3 class="panel-title">User</h3>
                </div>
                <div class="panel-body">
                    <button type="button" class="btn btn-sm btn-icon btn-primary btn-round waves-effect edit-user" data-target="#editUser" data-toggle="modal" data-toggle="tooltip" data-original-title="Edit">
                        <i class="icon md-edit" aria-hidden="true"></i>
                    </button>
                    Name: {{ user.name }}</br>
                    Surname: {{ user.surname }}</br>
                    Email: {{ user.email }}</br>
                    Phone number: {{ user.phoneNumber }}</br>
                    Address: {{ user.streetName }} {{ user.streetNumber }} {{ user.cityName }} {{ user.zipCode }} {{ user.countryRegion }} {{ user.countryName }}</br>
                    Birthdate: {{ user.birthdate|date('d/m/Y') }}</br>
                    Taxcode: {{ user.taxCode }}</br>
                    Typology: {{ user.status }}</br>
                    Presentation: {{ user.presentation.name | default('')}} - {% if user.presentation and user.presentation.date is not empty %}{{ user.presentation.date | date('d/m/Y')}}{% endif %} - {{ user.presentation.place | default('')}}</br>
                    Notes: {{ user.notes }}</br>
                </div>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="editUser" aria-hidden="true" role="dialog" >
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                            <h4 class="modal-title" id="exampleModalTitle">Update User</h4>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                {% include 'user/formUserEdit.html.twig' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Modal -->
        </div>

        <div class="col-sm-12 col-md-6">

            <div class="panel">
                <div class="panel-heading">
                    <h3 class="panel-title">Documents</h3>
                </div>
                <div class="panel-body">
                    {% for document in userDocuments %}
                        <button href="{{ path('documentDelete', {'userid': user.id, 'documentid': document.id}) }}" class="btn btn-sm btn-icon btn-danger btn-round btn-raised waves-effect waves-effect pull-right warningConfirm" data-toggle="tooltip" data-original-title="Delete file">
                            <i class="icon md-delete" aria-hidden="true"></i>
                        </button>
                        {{ document.name }} <br>
                        <a href="/download/{{ user.id }}/{{ document.documentName }}" target="_blank">{{ document.documentType }}</a><br>
                        {{ document.uploadAt|date('d/m/Y') }}<br><br>
                    {% endfor %}
                </div>
                <div class="panel-footer">
                    <button class="btn btn-primary waves-effect waves-light" data-target="#addDocument" data-toggle="modal" type="button">Add document</button>
                </div>
            </div>


            <!-- Modal -->
            <div class="modal fade" id="addDocument" aria-hidden="true" role="dialog" >
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                            <h4 class="modal-title" id="exampleModalTitle">Add document</h4>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                {% include 'user/formUserDocument.html.twig' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Modal -->
            <script>
                $( document ).ready(function() {

                    $('.warningConfirm').on("click", function() {
                        $target = $(this).attr('href');
                        console.log($target);
                        swal({
                            title: "Are you sure?",
                            text: "You will not be able to recover this file!",
                            type: "warning",
                            showCancelButton: true,
                            confirmButtonColor: '#DD6B55',
                            confirmButtonText: 'Yes, delete it!',
                            closeOnConfirm: false,
                            //closeOnCancel: false
                            },
                        function() {
                            swal({
                                title: "Deleted!",
                                text: "Your file has been deleted!",
                                type: "success",
                                showConfirmButton: false
                            });
                            setTimeout(function() {
                                window.location = $target;
                            }, 1000);
                        });
                    });

                });
            </script>
        </div>

    </div>

    <div class="row">

        <div class="col-sm-12 col-md-6">

            <div class="panel">
                <div class="panel-heading">
                    <h3 class="panel-title">Journey</h3>
                </div>
                <div class="panel-body">
                    {% for journey in userJourneys %}
                        <button type="button" data-id="{{ journey.id }}" class="btn btn-sm btn-icon btn-primary btn-round waves-effect edit-journey" data-target="#editJourney" data-toggle="modal" data-toggle="tooltip" data-original-title="Edit">
                            <i class="icon md-edit" aria-hidden="true"></i>
                        </button>
                        Clinic: {{ journey.clinic }}</br>
                        Arrival date: {{ journey.arrivalDate|date('d/m/Y') }}</br>
                        Appointment date: {{ journey.appointmentDate|date('d/m/Y') }}</br>
                        Departure date: {{ journey.departureDate|date('d/m/Y') }}</br>
                        Accommodation: {{ journey.accommodation }}</br>
                        Accommodation address: {{ journey.accommodationAddress }}</br>
                        Transport load to client: {{ journey.transportLoadClient }}</br>
                        Transport load to Hc: {{ journey.transportLoadHc }}</br>
                        Night load to client: {{ journey.nightLoadClient }}</br>
                        Night load to Hc: {{ journey.nightLoadHc }}</br>
                        Notes: {{ journey.notes }}</br></br>
                    {% endfor %}
                </div>
                <div class="panel-footer">
                    <button class="btn btn-primary waves-effect waves-light" data-target="#addJourney" data-toggle="modal" type="button">Add journey</button>
                </div>
            </div>

            <!-- Modal Add Journey-->
            <div class="modal fade" id="addJourney" aria-hidden="true" role="dialog" >
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                            <h4 class="modal-title" id="exampleModalTitle">Add Journey</h4>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                {% include 'user/formUserJourney.html.twig' %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Modal -->

            <!-- Modal Update Journey-->
            <div class="modal fade" id="editJourney" aria-hidden="true" role="dialog">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                            <h4 class="modal-title" id="exampleModalTitle">Update Journey</h4>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div id="ajaxresponse_formUserJourneyEdit"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Modal -->

            <script>
                $( document ).ready(function() {

                    $('.edit-journey').click(function() {
                        var id = $(this).data('id');
                        var route = '{{ path('ajax_formUserJourneyEdit', { 'id': "PLACEHOLDER" }) }}';
                        route = route.replace("PLACEHOLDER", id);
                        $.ajax({
                            type: 'POST',
                            url:  route,
                            success: function(response) {
                                $('#ajaxresponse_formUserJourneyEdit').html(response);
                                $('.modal-body').find('[data-plugin="select2"]').select2({ width: '100%' });
                            },
                            async: false
                        })
                    });
                });
            </script>
        </div>

    </div>

{% endblock %}